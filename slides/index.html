<!DOCTYPE HTML>
<html lang="fr">
<head>
	<title>Forum PHP 2015 : Mets du Value Object dans ton mod√®le</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=792, user-scalable=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<link rel="stylesheet" href="shower/themes/ribbon/styles/screen.css">
	<link rel="stylesheet" href="styles/prism.css" />
	<link rel="stylesheet" href="styles/custom.css">
</head>
<body class="list">
	<header class="caption">
		<h1>Forum PHP 2015 : Mets du Value Object dans ton mod√®le</h1>
		<p>Damien ALEXANDRE - Novembre 2015</p>
	</header>

	<section class="slide cover" id="coverpage"><div>
		<div class="covertitle">
			<h2>Mets du Value Object dans ton mod√®le</h2>
			<p>Forum PHP 2015 - Damien ALEXANDRE - Novembre 2015</p>
		</div>
        <img src="covers/jolicode-bg.jpg" />
    </div></section>

	<section class="slide"><div>
		<h2>Le barbu sur sc√®ne : Damien ALEXANDRE</h2>
		<ul>
			<li>Expert PHP &amp; Elasticsearch pour <img src="pictures/logo.svg" style="height:2em; vertical-align: text-bottom;">
                <ul>
                    <li>Agence sp√©cialis√© dans le d√©veloppement de projet web et mobile de qualit√© ;</li>
                    <li>Arte, Mediapart, Arianespace, Canal Plus...</li>
                    <li>√âquipe a taille humaine, change de job en <a href="http://jolicode.com/jobs" class="blink">cliquant ici</a>.</li>
                </ul>
            </li>
			<li><a href="https://twitter.com/damienalexandre">@damienalexandre</a> sur Twitter &amp; Github ;</li>
			<li>#symfony #elasticsearch #micro-typographie #beer #lego</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Bonjour 2015</h2>
		<ul>
			<li>On ne fait plus de proc√©dural ;</li>
			<li>Nos mod√®les de donn√©es sont riches ;</li>
			<li>On utilise la POO tous les jours ;</li>
			<li class="next">... au prix d'applications plus complexes.</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Ajout de phases de conception</h2>
		<ul>
			<li>On r√©fl√©chie avant de coder ;</li>
			<li>On utilise des plan de conception :
                <ul>
                    <li>respectant le besoin fonctionnel ;</li>
                    <li>permettant l'√©volution sans remise en cause ;</li>
                    <li>permettant d'√™tre productif.</li>
                </ul>
            </li>
            <li class="next">... Et c'est pas facile.</li>
        </ul>
	</div></section>

	<section class="slide"><div>
		<h2>
            Le DDD √† la rescousse
            <span>Domain Driven Design</span>
        </h2>

		<ul>
			<li>Tous le monde en a d√©j√† entendu parl√© ;</li>
            <li class="next">Personne ne sait trop ce que c'est ;</li>
			<li class="next">DDD n'est pas une techno ni une m√©thode de d√©veloppement ;</li>
			<li class="next">DDD est un <strong>ensemble de pratiques</strong>, fond√© sur la collaboration entre expert fonctionnels ;</li>
            <li class="next">DDD est une mani√®re de penser et de communiquer les probl√®mes et leurs solutions, entre les √©quipes techniques et fonctionnelles.</li>
        </ul>
	</div></section>

    <section class="slide shout"><div>
        <h2>STOP</h2>
    </div></section>

	<section class="slide"><div>
		<h2>Ceci n'est pas une conf√©rence sur le DDD</h2>

        <p>Allez plut√¥t voir :</p>

        <img src="pictures/alexandre-balmes.jpg" alt="Alexandre Balmes" style="display: block;height: 50%; float: left; margin-right: 10px;" />
        <p><strong>CHRONIQUE D'UN PROJET DRIVEN DESIGN</strong>
            <br>par Alexandre Balmes<br/>
            <small>le 23 √† 14h dans l'Auditorium Lucienne et Andr√© Blin</small></p>
    </div></section>

    <section class="slide"><div>
		<h2>Le Value Object</h2>

        <ul>
            <li>Un des outils fondamentaux du DDD ;</li>
            <li>On en fait des caisse mais en fait c'est tout simple ;</li>
            <li>La seule chose a retenir du DDD ? <img src="pictures/trollface.svg" alt="Trollface" style="height: 1.5em;"></li>
        </ul>
	</div></section>

    <section class="slide"><div>
		<h2>Le VO <span>C'est son petit nom :)</span></h2>

        <ul>
            <li>Un objet qui contient des donn√©es ;
                <ul>
                    <li>Musures ;</li>
                    <li>Quantit√©s ;</li>
                    <li>Descriptions ;</li>
                </ul>
            </li>
            <li>Il n'a pas d'identit√© (contrairement √† l'Entit√©) ;</li>
            <li>Il est immutable ;</li>
            <li>Son identit√© est bas√©e sur son contenu.</li>
        </ul>
    </div></section>

    <section class="slide"><div>
		<h2>Le VO connus</h2>

        <ul>
            <li>\DateTimeImmutable (PHP 5.5)</li>
            <li>Address</li>
            <li>Money</li>
            <li>Location</li>
            <li class="next">On retrouve toujours les m√™mes exemples, innovons!</li>
        </ul>
    </div></section>

    <section class="slide cover"><div>
        <h2>Avec l'aide de mon assistant</h2>
        <img src="pictures/georgewants-nespresso.jpg" alt="">
    </div></section>

    <section class="slide"><div>
        <h2 style="margin-bottom: 0;">Une cafeti√®re
        <span>Conf√©rence non sponsoris√©e.</span>
        </h2>
        <img src="pictures/maker.jpg" alt="" style="height: 90%; margin: 0 auto; display: block;">
    </div></section>

    <section class="slide"><div>
		<h2>Un objet cafeti√®re</h2>

        <pre><code class="language-php">class CoffeeMaker
{
    private $id;
    private $model;
    private $currentCapsule;
}</code></pre>
	</div></section>

    <section class="slide"><div>
		<h2>La capsule ?</h2>

        <pre><code class="language-php">$maker = new CoffeeMaker();
$maker->setModel('Magimix 42');
$maker->setCurrentCapsule(
    // ??? Wat ???
);</code></pre>

        <p>Une capsule poss√©de un nom, un ar√¥me, une couleur... et une identit√©.</p>
	</div></section>

    <section class="slide"><div>
		<h2>On pourrait faire ce genre de capsule</h2>

        <pre><code class="language-php">class Capsule
{
    private $id;
    private $name;
    private $color;
    private $intensity;
}</code></pre>
    </div></section>

    <section class="slide"><div>
        <h2>MAIS</h2>

        <ul>
            <li>name, color, intensity‚Ä¶ d√©crivent une capsule ;</li>
            <li>la validation de la couleur serait le r√¥le de la Capsule ?! Viole le principe de Simple Responsability ;</li>
            <li>difficult√© de r√©utilisation : si je veux un objet User, qui aurait un type de capsule pr√©f√©r√©e ?</li>
            <li>m√©lange des pr√©ocupations.</li>
        </ul>

        <p>On tient notre candidat pour devenir un VO !</p>
    </div></section>


    <section class="slide"><div>
        <h2>Notre VO CapsuleType !</h2>

        <pre><code class="language-php">class CapsuleType
{
    private $name;
    private $color;
    private $intensity;
}

$capsule = new Capsule();
$capsule->setType(
    new CapsuleType("JoliBrew")
);

$maker->setCurrentCapsule($capsule);
</code></pre>
    </div></section>

    <section class="slide"><div>
        <h2>Notre VO CapsuleType !</h2>

        <ul>
            <li>Il va contenir toute l'intelligence d'un type de capsule de caf√©, tout est encapsul√© (badum tsss!) ;</li>
            <li>Nous allons y mettre la validation (couleur valide, etc) ;</li>
            <li>Il est r√©utilisable, pour d'autres objets qui auraient besoin d'un type de capsule (User) ;</li>
            <li>Il peut contenir des m√©thodes / comportements propres aux types de capsules (<code>isDecaf()</code>)...</li>
            <li>C'est aussi pour facile √† tester et √† maintenir !</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>CapsuleType n'a pas d'identit√©</h2>

        <p><strong>Un CapsuleType s'identifie par son contenu.</strong></p>

        <p>
            On peut dire que deux Capsules sont du m√™me type si les attributs de
            CapsuleType sont identiques dans les deux Capsules.
        </p>
    </div></section>

    <section class="slide"><div>
        <h2>La Capsule a une identit√©</h2>

        <p><strong>La Capsule est identifi√©e</strong>, deux Capsules du m√™me type ne sont pas consid√©r√© comme √©tant la m√™me : elles
            se manipulent, se suppriment, se consomment - elles ont une vie propre dans notre domaine.</p>

        <p>Capsule est une entit√©. Tout comme CoffeeMaker.</p>
    </div></section>

    <section class="slide"><div>
        <h2>L'exemple complet</h2>

<pre><code class="language-php">$roma  = new CapsuleType('Roma', 'purple', 'intense et cr√©meux', 9);

$capsule = new Capsule();
$capsule->setType($roma);

$maker = new CoffeeMaker();
$maker->setModel('Magimix 42');
$maker->setCurrentCapsule($capsule);</code></pre>
    </div></section>

    <section class="slide"><div>
        <h2>Identit√©</h2>

        <p>Pour savoir si deux caf√©ti√®res sont sur le point de pr√©parer le m√™me caf√©, on compare donc d√©sormais des objets !</p>

        <pre><code class="language-php">$ristretto  = new CapsuleType('Ristretto', 'black');
$roma       = new CapsuleType('Roma', 'purple');

$ristretto == $roma; // false</code></pre>

        <p>Oui on utilise <code>==</code>.</p>
    </div></section>

    <section class="slide"><div>
        <h2>√âgalit√© d'objets en PHP
            <span>Le saviez-vous ?</span></h2>

        <pre><code class="language-php">class VO {
    private $test;
    public function __construct($test) {
        $this->test = $test;
    }
}

$foo = new VO('I need coffee');
$bar = new VO('I need coffee');

var_dump($one == $two); // true !
var_dump($one === $two); // false
</code></pre>
    </div></section>

    <section class="slide"><div>
        <h2>√âgalit√© d'objet en PHP</h2>

        <ul>
            <li><code>===</code> compare uniquement la r√©f√©rence m√©moire de l'objet ;</li>
            <li><code>==</code> compare le nom de la classe et les valeurs des attributs ;</li>
        </ul>

        <p>On compare donc nos VO avec <code>==</code> et on assume.</p>

        <small>Vous pouvez aussi √©crire une m√©thode <code>isEqual()</code> si vous avez trop de temps libre
            et que vous aimez r√©inventer la roue (ou si vous faite de l'h√©ritage de VO).</small>
    </div></section>

    <section class="slide"><div>
        <h2>Deux VO identiques != m√™me instance</h2>

        <pre><code class="language-php">$roma = new CapsuleType('Roma', 'purple', 'intense et cr√©meux', 9);</code></pre>

        <p>
            Dans un monde id√©al, toutes les capsule Roma seraient repr√©sent√© par la m√™me <strong>instance</strong> de CapsuleType.<br />
            Dans la vraie vie, ce n'est pas le cas :
        </p>
        <ul>
            <li>on code comme des pieds ;</li>
            <li>notre ORM ne g√®re pas les VO ;</li>
            <li>c'est p√©nible de se trainer des instances partout.</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>Deux VO identiques != m√™me instance</h2>


        <p>Aucun probl√®me. Cr√©ez autant de <code>$roma</code> que vous voulez.</p>

        <p>Ce qui est important, c'est que vous puissiez toujours les comparer :</p>

        <pre><code class="language-php">$roma = new CapsuleType('Roma', 'purple', 'intense et cr√©meux', 9);
$romaFromORM == $roma; // TRUE \o/</code></pre>
    </div></section>


    <section class="slide"><div>
        <h2>Changer de caf√© ?</h2>

        <pre><code class="language-php">$maker; // Notre cafeti√®re
$maker->getCurrentCapsule(); // Notre Capsule
$maker->getCurrentCapsule()->getType(); // Notre CapsuleType
$maker->getCurrentCapsule()->getType()->setName('Ristretto'); // NO!!</code></pre>

        <p>On va utiliser une autre instance de <code>CapsuleType</code> : <strong>toujours</strong>.</p>
    </div></section>

    <section class="slide cover"><div>
        <h2>IRL on ne "change" pas le caf√© de la capsule&nbsp;</h2>
        <img src="pictures/capsuleWar.jpg" alt="">
    </div></section>


    <section class="slide"><div>
        <h2>Immutabilit√©</h2>

        <p>Le propre d'un VO est d'√™tre immutable : vous ne pouvez pas en changer le contenu. C'est super important.</p>

        <ul>
            <li>Une instance de <code>CapsuleType</code> ne peux pas se retrouver dans un √©tat invalide (couleur manquante par exemple) ;</li>
            <li>Changer la valeur d'un VO doit revenir a changer d'objet ;</li>
            <li>Si le VO est utilis√© ailleurs, il n'y a pas d'effets de bords&nbsp;;</li>
            <li>Si la classe √©volue, √ßa casse l'existant (c'est voulu).</li>
        </ul>
    </div></section>


    <section class="slide"><div>
        <h2>Pourquoi immutable</h2>

        <p>Une cafeti√®re peut changer de Capsule, d'√©tat (allum√©, √©teind), d'emplacement (cuisine, WC). Elle sera toujours <strong>la m√™me cafeti√®re</strong>.
            C'est une entit√©.</p>

        <p><strong>Mais le type de capsule Roma, si on change sa couleur, ce n'est plus le m√™me type.</strong></p>
    </div></section>


    <section class="slide"><div>
        <h2>Rendre un objet PHP immutable</h2>

        <pre><code class="language-php">class CapsuleType
{
    private $name; // Priv√©, sans setter

    public function __construct($name)
    {
        $this->name = $name;
    }
}</code></pre>
    </div></section>


    <section class="slide"><div>
        <h2>Trop permissif</h2>

        <pre><code class="language-php">class MyFlexibleCapsuleType extends CapsuleType
{
    private $name;

    public function setName($name) {
        $this->name = $name;
    }
}
</code></pre>
    </div></section>


    <section class="slide"><div>
        <h2>Mot cl√© final</h2>

        <pre><code class="language-php">final class CapsuleType // final = no extends
{
    private $name;

    public function __construct($name)
    {
        $this->name = $name;
    }
}</code></pre>
    </div></section>


    <section class="slide"><div>
        <h2>Toujours trop permissif !</h2>

        <pre><code class="language-php">$roma = new CapsuleType($roma);

// Malicious code‚Ä¶
$roma->__construct("HAHA");

// var_dump($roma);

class CapsuleType#5 (1) {
    private $name => string(4) "HAHA"
}</code></pre>
    </div></section>


    <section class="slide cover"><div>
        <img src="pictures/blown.gif" style="width: 100%; margin-top: 10%;" alt="">
    </div></section>



    <section class="slide"><div>
        <h2>Faire du "vrai" immutable</h2>

        <pre><code class="language-php">final class CapsuleType
{
    private $name;

    private function __construct() {} // Pas de constructeur

    public static function fromName($name) // Une statique
    {
        $type = new CapsuleType();
        $type>name = $name;

        return $type;
    }
}</code></pre>
    </div></section>

    <section class="slide"><div>
        <h2>Enfin !</h2>

        <pre><code class="language-php">$capsuleType = CapsuleType::fromName("Roma");</code></pre>

        <p>Ou pas...</p>
    </div></section>

    <section class="slide"><div>
        <h2>On est en PHP üòú</h2>

        <pre><code class="language-php">$refObject   = new ReflectionObject($roma);
$refProperty = $refObject->getProperty('name');
$refProperty->setAccessible(true);
$refProperty->setValue($one, 'Trolololol');</code></pre>

        <p>Mais on s'√©gare...</p>
    </div></section>

    <section class="slide"><div>
        <h2>Immutable c'est dans la t√™te <span>surtout en PHP</span></h2>

        <p>Communiquez, documentez, adoptez une convention, un namespace‚Ä¶ Ne laissez pas vos coll√®gues impl√©menter un setter et tout ira bien.</p>
    </div></section>


    <section class="slide cover"><div>
        <h2 style="background: none;">La persistence</h2>
        <img src="pictures/doctrinewhat.png" alt="">
    </div></section>


    <section class="slide"><div>
        <h2>Avec PHP et Doctrine 2.5</h2>

        <p>Je suis l√† pour vous parler de Doctrine, deux strat√©gies :</p>

        <ul>
            <li>Utiliser Embeddable ;</li>
            <li>Utiliser le type "object".</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>Type object</h2>

        <p>La fa√ßon historique de faire du VO avec Doctrine.</p>

        <ul>
            <li>Utilise <code>serialize/unserialize</code> pour stocker vos VO ;</li>
            <li>Pas possible de requ√™ter sur les propri√©t√©s de l'objet ;</li>
            <li>Refactoring complexe (namespace en dur) ;</li>
            <li>Pr√©sent depuis les d√©buts de Doctrine.</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>Notre exemple</h2>

        <p>Chaque utilisateur dans notre domaine peut avoir un type de capsule pr√©f√©r√©.</p>
        <p>Nous avons une <strong>entit√© User</strong> et un <strong>VO CapsuleType</strong>.</p>

        <img src="pictures/clooneySwag.png" alt="" style="float: right;">
    </div></section>


    <section class="slide"><div>
        <h2>Utilisation du type object</h2>

        <pre><code class="language-php">/** @Entity */
class User
{
    /**
     * @var CapsuleType
     * @Column(type="object")
     */
    private $favoriteCapsuleType;
}</code></pre>

        <p>Rien de particulier sur l'objet ! #win</p>
    </div></section>

    <section class="slide"><div>
        <h2>Attention a bien forcer un type</h2>

        <pre><code class="language-php">/**
 * @param CapsuleType $type
 */
public function setFavoriteCapsuleType(CapsuleType $type)
{
    $this->favoriteCapsuleType = $type;
}</code></pre>

        <p>Type hint obligatoire, pas de validation par Doctrine.</p>
    </div></section>

    <section class="slide"><div>
        <h2>Le sch√©ma g√©n√©r√©</h2>

        <table>
            <tr>
                <th scope="row">id</th>
                <td>int(11)</td>
            </tr>
            <tr>
                <th scope="row">favoriteCapsuleType</th>
                <td>longtext</td>
            </tr>
        </table>

        <p>Avec un commentaire : <code>(DC2Type:object)</code>, attention √† votre SGBD.</p>
    </div></section>


    <section class="slide"><div>
        <h2>Utilisation naturelle</h2>

        <pre><code class="language-php">$ristretto = CapsuleType::fromValues('Ristretto');

$user   = new User();
$user>setFavoriteCapsuleType($ristretto);

$entityManager->persist($user);
$entityManager->flush();</code></pre>
    </div></section>


    <section class="slide"><div>
        <h2>En base de donn√©e</h2>

        <table>
            <tr>
                <th scope="row">id</th>
                <td><code>1</code></td>
            </tr>
            <tr>
                <th scope="row">favoriteCapsuleType</th>
                <td><code>O:17:"Model\CapsuleType":1:{s:23:"Model\CapsuleTypename";s:9:"Ristretto"}</code></td>
            </tr>
        </table>

        <p>C'est juste un peu moche.</p>
    </div></section>


	<div class="progress"><div></div></div>
	<script src="shower/shower.min.js"></script>
	<script src="styles/prism.js"></script>
	<script src="styles/jquery-2.1.1.min.js"></script>
	<script src="styles/progress.js"></script>
</body>
</html>
