<!DOCTYPE HTML>
<html lang="fr">
<head>
	<title>Forum PHP 2015 : Mets du Value Object dans ton mod√®le</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=792, user-scalable=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<link rel="stylesheet" href="shower/themes/ribbon/styles/screen.css">
	<link rel="stylesheet" href="styles/prism.css" />
	<link rel="stylesheet" href="styles/custom.css">
</head>
<body class="list">
	<header class="caption">
		<h1>Forum PHP 2015 : Mets du Value Object dans ton mod√®le</h1>
		<p>Damien ALEXANDRE - Novembre 2015</p>
	</header>

	<section class="slide cover" id="coverpage"><div>
		<div class="covertitle">
			<h2>Mets du Value Object dans ton mod√®le</h2>
			<p>Forum PHP 2015 - Damien ALEXANDRE - Novembre 2015</p>
		</div>
        <img src="covers/jolicode-bg.jpg" />
    </div></section>

	<section class="slide"><div>
		<h2>Le barbu sur sc√®ne : Damien ALEXANDRE</h2>
		<ul>
			<li>Expert PHP &amp; Elasticsearch pour <img src="pictures/logo.svg" style="height:2em; vertical-align: text-bottom;">
                <ul>
                    <li>Agence sp√©cialis√© dans le d√©veloppement de projet web et mobile de qualit√© ;</li>
                    <li>Arte, Mediapart, Arianespace, Canal Plus...</li>
                    <li>√âquipe √† taille humaine, change de job en <a href="http://jolicode.com/jobs" class="blink">cliquant ici</a>.</li>
                </ul>
            </li>
			<li><a href="https://twitter.com/damienalexandre">@damienalexandre</a> sur Twitter &amp; Github ;</li>
			<li>#symfony #elasticsearch #micro-typographie #beer #lego</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Bonjour 2015</h2>
		<ul>
			<li>On ne fait plus de full proc√©dural ;</li>
			<li>Nos mod√®les de donn√©es sont riches ;</li>
			<li>On utilise la POO tous les jours ;</li>
			<li class="next">... au prix d'applications plus complexes.</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Ajout de phases de conception</h2>
		<ul>
			<li>On r√©fl√©chie avant de coder ;</li>
			<li>On utilise des plans de conception :
                <ul>
                    <li>respectant le besoin fonctionnel ;</li>
                    <li>permettant l'√©volution sans remise en cause ;</li>
                    <li>permettant d'√™tre productif.</li>
                </ul>
            </li>
            <li class="next">... Et c'est pas facile.</li>
        </ul>
	</div></section>

	<section class="slide"><div>
		<h2>
            Le DDD √† la rescousse
            <span>Domain Driven Design</span>
        </h2>

		<ul>
			<li>Tous le monde en a d√©j√† entendu parl√© ;</li>
            <li class="next">Personne ne sait trop ce que c'est ;</li>
			<li class="next">DDD n'est pas une techno ni une m√©thode de d√©veloppement ;</li>
			<li class="next">DDD est un <strong>ensemble de pratiques</strong>, fond√© sur la collaboration entre experts fonctionnels ;</li>
            <li class="next">DDD est une mani√®re de penser et de communiquer les probl√®mes et leurs solutions,
                entre les √©quipes techniques et fonctionnelles.</li>
        </ul>
	</div></section>

    <section class="slide shout"><div>
        <h2>STOP</h2>
    </div></section>

	<section class="slide"><div>
		<h2>Ceci n'est pas une conf√©rence sur le DDD</h2>

        <p>Allez plut√¥t voir :</p>

        <img src="pictures/alexandre-balmes.jpg" alt="Alexandre Balmes" style="display: block;height: 50%; float: left; margin-right: 10px;" />

        <p>
            <strong>CHRONIQUE D'UN PROJET DRIVEN DESIGN</strong>
            <br>par Alexandre Balmes<br/>
            <small>le 23 √† 14h dans l'Auditorium Lucienne et Andr√© Blin</small>
        </p>
    </div></section>

    <section class="slide"><div>
		<h2>Le Value Object</h2>

        <ul>
            <li>Un des outils fondamentaux du DDD ;</li>
            <li>On en fait des caisses mais en fait c'est tout simple ;</li>
            <li class="next">La seule chose a retenir du DDD ? <img src="pictures/trollface.svg" alt="Trollface" style="height: 1.5em;"></li>
        </ul>
	</div></section>

    <section class="slide"><div>
		<h2>Le VO <span>C'est son petit nom :)</span></h2>

        <ul>
            <li>Un objet qui contient des donn√©es :
                <ul>
                    <li>Mesures ;</li>
                    <li>Quantit√©s ;</li>
                    <li>Descriptions ;</li>
                </ul>
            </li>
            <li>Il n'a pas d'identit√© (contrairement √† l'entit√©) ;</li>
            <li>Il est immutable ;</li>
            <li>Son identit√© est bas√©e sur son contenu.</li>
        </ul>
    </div></section>

    <section class="slide"><div>
		<h2>Le VO connus</h2>

        <ul>
            <li>\DateTimeImmutable (PHP 5.5)</li>
            <li>Address</li>
            <li>Money</li>
            <li>Location</li>
            <li class="next">On retrouve toujours les m√™mes exemples, innovons!</li>
        </ul>
    </div></section>

    <section class="slide cover"><div>
        <h2>Avec l'aide de mon assistant</h2>
        <img src="pictures/georgewants-nespresso.jpg" alt="">
    </div></section>

    <section class="slide"><div>
        <h2 style="margin-bottom: 0;">Une cafeti√®re
        <span>Conf√©rence non sponsoris√©e.</span>
        </h2>
        <img src="pictures/maker.jpg" alt="" style="height: 90%; margin: 0 auto; display: block;">
    </div></section>

    <section class="slide"><div>
		<h2>Un objet cafeti√®re</h2>

        <pre><code class="language-php">class CoffeeMaker
{
    private $id;
    private $model;
    private $currentCapsule;
}</code></pre>
	</div></section>

    <section class="slide"><div>
		<h2>La capsule ?</h2>

        <pre><code class="language-php">$maker = new CoffeeMaker();
$maker->setModel('Magimix 42');
$maker->setCurrentCapsule(
    // ??? Wat ???
);</code></pre>

        <p>Une capsule poss√®de un nom, un ar√¥me, une couleur... et une identit√©.</p>
	</div></section>

    <section class="slide"><div>
		<h2>On pourrait faire ce genre de capsule</h2>

        <pre><code class="language-php">class Capsule
{
    private $id;
    private $name;
    private $color;
    private $intensity;
}</code></pre>
    </div></section>

    <section class="slide"><div>
        <h2>MAIS</h2>

        <ul>
            <li>name, color, intensity... d√©crivent une capsule ;</li>
            <li>la validation de la couleur serait le r√¥le de la Capsule ?! Viole le principe de Simple Responsability ;</li>
            <li>difficult√© de r√©utilisation : si je veux un objet User, qui aurait un type de capsule pr√©f√©r√©e ?</li>
            <li>grand m√©lange des pr√©ocupations.</li>
        </ul>

        <p>Et si on en faisait un VO !</p>
    </div></section>


    <section class="slide"><div>
        <h2>Notre VO CapsuleType !</h2>

        <ul>
            <li>Il va contenir toute l'intelligence d'un type de capsule de caf√©, tout est encapsul√© (badum tsss!) ;</li>
            <li>Nous allons y mettre la validation (couleur valide, etc) ;</li>
            <li>Il est r√©utilisable, pour d'autres objets qui auraient besoin d'un type de capsule (User) ;</li>
            <li>Il peut contenir des m√©thodes / comportements propres aux types de capsules (<code>isDecaf()</code>)...</li>
            <li>C'est aussi plus facile √† tester et √† maintenir !</li>
        </ul>
    </div></section>


    <section class="slide"><div>
        <h2>Notre VO CapsuleType !</h2>

        <pre><code class="language-php">class CapsuleType
{
    private $name;
    private $color;
    private $intensity;
}

$capsule = new Capsule();
$capsule->setType(
    new CapsuleType("JoliBrew")
);

$maker->setCurrentCapsule($capsule);</code></pre>
    </div></section>


    <section class="slide"><div>
        <h2>CapsuleType n'a pas d'identit√©</h2>

        <p><strong>Un CapsuleType s'identifie par son contenu.</strong></p>

        <p>
            On peut dire que deux Capsules sont du m√™me type si les attributs de
            CapsuleType sont identiques dans les deux Capsules.
        </p>
    </div></section>

    <section class="slide"><div>
        <h2>La Capsule a une identit√©</h2>

        <p><strong>La Capsule est identifi√©e</strong>, deux Capsules du m√™me type ne sont pas consid√©r√© comme √©tant la m√™me : elles
            se manipulent, se suppriment, se consomment - elles ont une vie propre dans notre domaine.</p>

        <p>Capsule est une entit√©. Tout comme CoffeeMaker.</p>
    </div></section>

    <section class="slide"><div>
        <h2>L'exemple complet</h2>

<pre><code class="language-php">$roma  = new CapsuleType('Roma', 'purple', 'intense et cr√©meux', 9);

$capsule = new Capsule();
$capsule->setType($roma);

$maker = new CoffeeMaker();
$maker->setModel('Magimix 42');
$maker->setCurrentCapsule($capsule);</code></pre>
    </div></section>

    <section class="slide"><div>
        <h2>Identit√©</h2>

        <p>Pour savoir si deux caf√©ti√®res sont sur le point de pr√©parer le m√™me caf√©, on compare donc d√©sormais des objets !</p>

        <pre><code class="language-php">$ristretto  = new CapsuleType('Ristretto', 'black');
$roma       = new CapsuleType('Roma', 'purple');

$ristretto == $roma; // false</code></pre>

        <p>Oui on utilise <code>==</code>.</p>
    </div></section>

    <section class="slide"><div>
        <h2>√âgalit√© d'objets en PHP
            <span>Le saviez-vous ?</span></h2>

        <pre><code class="language-php">class VO {
    private $test;
    public function __construct($test) {
        $this->test = $test;
    }
}

$foo = new VO('I need coffee');
$bar = new VO('I need coffee');

var_dump($one == $two); // true !
var_dump($one === $two); // false
</code></pre>
    </div></section>

    <section class="slide"><div>
        <h2>√âgalit√© d'objet en PHP</h2>

        <ul>
            <li><code>===</code> compare uniquement la r√©f√©rence m√©moire de l'objet ;</li>
            <li><code>==</code> compare le nom de la classe et les valeurs des attributs ;</li>
        </ul>

        <p>On compare donc nos VO avec <code>==</code> et on assume.</p>

        <small>Vous pouvez aussi √©crire une m√©thode <code>isEqual()</code> si vous avez trop de temps libre
            et que vous aimez r√©inventer la roue (ou si vous faite de l'h√©ritage de VO).</small>
    </div></section>

    <section class="slide"><div>
        <h2>Deux VO identiques != m√™me instance</h2>

        <pre><code class="language-php">$roma = new CapsuleType('Roma', 'purple', 'intense et cr√©meux', 9);</code></pre>

        <p>
            Dans un monde id√©al, toutes les capsule Roma seraient repr√©sent√© par la m√™me <strong>instance</strong> de CapsuleType.<br />
            Dans la vraie vie, ce n'est pas le cas :
        </p>
        <ul>
            <li>on code comme des pieds ;</li>
            <li>notre ORM ne g√®re pas les VO ;</li>
            <li>c'est p√©nible de se trainer des instances partout.</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>Deux VO identiques != m√™me instance</h2>


        <p>Aucun probl√®me. Cr√©ez autant de <code>$roma</code> que vous voulez.</p>

        <p>Ce qui est important, c'est que vous puissiez toujours les comparer :</p>

        <pre><code class="language-php">$roma = new CapsuleType('Roma', 'purple', 'intense et cr√©meux', 9);
$romaFromORM == $roma; // TRUE \o/</code></pre>
    </div></section>


    <section class="slide"><div>
        <h2>Changer de caf√© ?</h2>

        <pre><code class="language-php">$maker; // Notre cafeti√®re
$maker->getCurrentCapsule(); // Notre Capsule
$maker->getCurrentCapsule()->getType(); // Notre CapsuleType
$maker->getCurrentCapsule()->getType()->setName('Ristretto'); // NO!!</code></pre>

        <p>On va <strong>toujours</strong> utiliser une autre instance de <code>CapsuleType</code> !</p>
    </div></section>

    <section class="slide cover"><div>
        <h2>IRL on ne "change" pas le caf√© de la capsule&nbsp;</h2>
        <img src="pictures/capsuleWar.jpg" alt="">
    </div></section>


    <section class="slide"><div>
        <h2>Immutabilit√©</h2>

        <p>Le propre d'un VO est d'√™tre immutable : vous ne <del>pouvez</del> devez pas en changer le contenu. C'est super important.</p>

        <ul>
            <li>Une instance de <code>CapsuleType</code> ne peux pas se retrouver dans un √©tat invalide (couleur manquante par exemple) ;</li>
            <li>Changer la valeur d'un VO doit revenir √† changer d'objet ;</li>
            <li>Si le VO est utilis√© ailleurs, il n'y a pas d'effets de bords&nbsp;;</li>
            <li>Si la classe √©volue, √ßa casse l'existant (c'est voulu).</li>
        </ul>
    </div></section>


    <section class="slide"><div>
        <h2>Pourquoi immutable</h2>

        <p>Une cafeti√®re peut changer de Capsule, d'√©tat (allum√©, √©teinte), d'emplacement (cuisine, WC). Elle sera toujours <strong>la m√™me cafeti√®re</strong>.
            C'est une entit√©.</p>

        <p><strong>Mais le type de capsule Roma, si on change sa couleur, ce n'est plus le m√™me type.</strong></p>
    </div></section>


    <section class="slide"><div>
        <h2>Rendre un objet PHP immutable</h2>

        <pre><code class="language-php">class CapsuleType
{
    private $name; // Priv√©, sans setter

    public function __construct($name)
    {
        $this->name = $name;
    }
}</code></pre>
    </div></section>


    <section class="slide"><div>
        <h2>Trop permissif</h2>

        <pre><code class="language-php">class MyFlexibleCapsuleType extends CapsuleType
{
    private $name;

    public function setName($name) {
        $this->name = $name;
    }
}
</code></pre>
    </div></section>


    <section class="slide"><div>
        <h2>Mot cl√© final</h2>

        <pre><code class="language-php">final class CapsuleType // final = no extends
{
    private $name;

    public function __construct($name)
    {
        $this->name = $name;
    }
}</code></pre>
    </div></section>


    <section class="slide"><div>
        <h2>Toujours trop permissif !</h2>

        <pre><code class="language-php">$roma = new CapsuleType('Roma');

// Malicious code‚Ä¶
$roma->__construct("HAHA");

// var_dump($roma);

class CapsuleType#5 (1) {
    private $name => string(4) "HAHA"
}</code></pre>
    </div></section>


    <section class="slide cover"><div>
        <img src="pictures/blown.gif" style="width: 100%; margin-top: 10%;" alt="">
    </div></section>



    <section class="slide"><div>
        <h2>Faire du "vrai" immutable</h2>

        <pre><code class="language-php">final class CapsuleType
{
    private $name;

    private function __construct() {} // Pas de constructeur

    public static function fromName($name) // Une statique
    {
        $type = new CapsuleType();
        $type>name = $name;

        return $type;
    }
}</code></pre>
    </div></section>

    <section class="slide"><div>
        <h2>Enfin !</h2>

        <pre><code class="language-php">$capsuleType = CapsuleType::fromName("Roma");</code></pre>

        <p>Ou pas...</p>
    </div></section>

    <section class="slide"><div>
        <h2>On est en PHP üòú</h2>

        <pre><code class="language-php">$refObject   = new ReflectionObject($roma);
$refProperty = $refObject->getProperty('name');
$refProperty->setAccessible(true);
$refProperty->setValue($one, 'Trolololol');</code></pre>

        <p>Mais on s'√©gare...</p>
    </div></section>

    <section class="slide"><div>
        <h2>Immutable c'est dans la t√™te <span>surtout en PHP</span></h2>

        <p>Communiquez, documentez, adoptez une convention, un namespace‚Ä¶ Ne laissez pas vos coll√®gues impl√©menter un setter et tout ira bien.</p>
    </div></section>


    <section class="slide cover"><div>
        <h2 style="background: none;">La persistence</h2>
        <img src="pictures/doctrinewhat.png" alt="">
    </div></section>


    <section class="slide"><div>
        <h2>Avec PHP et Doctrine 2.5</h2>

        <p>Je suis l√† pour vous parler de Doctrine, deux strat√©gies :</p>

        <ul>
            <li>Utiliser <code>Embeddable</code> ;</li>
            <li>Utiliser le type <code>object</code>.</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>Type object</h2>

        <p>La fa√ßon historique de faire du VO avec Doctrine.</p>

        <ul>
            <li>Utilise <code>serialize/unserialize</code> pour stocker vos VO ;</li>
            <li>Vous laisse totalement la main sur ce que contient le champ ;</li>
            <li>Totalement transparent pour le d√©veloppeur ;</li>
            <li>Pr√©sent depuis les d√©buts de Doctrine.</li>
        </ul>
    </div></section>

    <section class="slide"><div>
        <h2>Notre exemple</h2>

        <p>Chaque utilisateur dans notre domaine peut avoir un type de capsule pr√©f√©r√©.</p>
        <p>Nous avons une <strong>entit√© User</strong> et un <strong>VO CapsuleType</strong>.</p>

        <img src="pictures/clooneySwag.png" alt="" style="float: right;">
    </div></section>


    <section class="slide"><div>
        <h2>Utilisation du type object</h2>

        <pre><code class="language-php">/** @Entity */
class User
{
    /**
     * @var CapsuleType
     * @Column(type="object")
     */
    private $favoriteCapsuleType;
}</code></pre>

        <p>Rien de particulier sur l'objet ! #win</p>
    </div></section>

    <section class="slide"><div>
        <h2>Attention √† bien forcer un type</h2>

        <pre><code class="language-php">/**
 * @param CapsuleType $type
 */
public function setFavoriteCapsuleType(CapsuleType $type)
{
    $this->favoriteCapsuleType = $type;
}</code></pre>

        <p>Type hint obligatoire, pas de validation par Doctrine.</p>
    </div></section>

    <section class="slide"><div>
        <h2>Le sch√©ma g√©n√©r√©</h2>

        <table>
            <tr>
                <th scope="row">id</th>
                <td>int(11)</td>
            </tr>
            <tr>
                <th scope="row">favoriteCapsuleType</th>
                <td>longtext</td>
            </tr>
        </table>

        <p>Avec un commentaire : <code>(DC2Type:object)</code>, attention √† votre SGBD.</p>
    </div></section>


    <section class="slide"><div>
        <h2>Utilisation naturelle</h2>

        <pre><code class="language-php">$ristretto = CapsuleType::fromValues('Ristretto');

$user   = new User();
$user>setFavoriteCapsuleType($ristretto);

$entityManager->persist($user);
$entityManager->flush();</code></pre>
    </div></section>


    <section class="slide"><div>
        <h2>En base de donn√©e</h2>

        <table>
            <tr>
                <th scope="row">id</th>
                <td>1</td>
            </tr>
            <tr>
                <th scope="row">favoriteCapsuleType</th>
                <td>O:17:"Model\CapsuleType":1:{s:23:"Model\CapsuleTypename";s:9:"Ristretto"}</td>
            </tr>
        </table>

        <p>C'est juste un peu moche.</p>
    </div></section>



    <section class="slide"><div>
        <h2>Hydratation propre, on r√©cup√®re notre VO</h2>

        <pre><code class="language-php">$entityManager->find(User::class, 1);

// Retour de Doctrine
class Model\User {
    private $id => int(1)
    private $favoriteCapsuleType => class Model\CapsuleType {
        private $name => string(9) "Ristretto"
    }
}</code></pre>
    </div></section>


    <section class="slide"><div>
        <h2>Quelques inconv√©nients</h2>

        <ul>
            <li>Pas de requ√™te possible sur les champs du VO ;</li>
            <li>S√©rialisation PHP, non standard, non int√©rop√©rable ;</li>
            <li>Couplage fort, impossible de renommer la classe par exemple.</li>
        </ul>
    </div></section>


    <section class="slide"><div>
        <h2>Introducing Embeddable !</h2>

        <ul>
            <li>Nouvelle fonctionnalit√© merg√© le 8 f√©vrier 2014 ;</li>
            <li class="next">Released le 2 avril 2015 !</li>
            <li>Uniquement disponible dans Doctrine >= 2.5 donc ;</li>
            <li><code>@Embedded</code> et <code>@Embeddable</code> ;</li>
            <li>Copie les champs du VO dans la table de l'entit√© ;</li>
            <li>Similaire a Hibernate Embedded.</li>
        </ul>
    </div></section>



    <section class="slide"><div>
        <h2>Notre objet Embeddable, le VO CapsuleType</h2>

        <pre><code class="language-php">/** @Embeddable */
final class CapsuleType
{
    /** @Column(type="string") */
    private $name;

    private function __construct() {}

    public static function fromValues($name)
    {
        $type = new CapsuleType();
        $type->name = $name; // ...
        return $type;
    }
}</code></pre>
    </div></section>


    <section class="slide"><div style="padding: 10px 100px 10px 100px; height: 550px;">
        <h2>Notre entit√© User</h2>

        <pre><code class="language-php">/** @Entity */
class User {
    /**
     * @Id
     * @Column(type="integer")
     * @GeneratedValue
     */
    private $id;

    /**
     * @Embedded(class="CapsuleType")
     */
    private $favoriteCapsuleType;

    /**
     * @param CapsuleType $favoriteCapsuleType
     */
    public function setFavoriteCapsuleType(CapsuleType $type) // ...</code></pre>
    </div></section>



    <section class="slide"><div>
        <h2>Le sch√©ma g√©n√©r√©</h2>

        <table>
            <tr>
                <th scope="row">id</th>
                <td>int(11)</td>
            </tr>
            <tr>
                <th scope="row">favoriteCapsuleType_name</th>
                <td>varchar(255)</td>
            </tr>
            <tr class="next">
                <th scope="row">favoriteCapsuleType_intensity</th>
                <td>int(2)</td>
            </tr>
            <tr class="next">
                <th scope="row">favoriteCapsuleType_color</th>
                <td>varchar(12)</td>
            </tr>
            <tr class="next">
                <th scope="row">...</th>
                <td>...</td>
            </tr>
        </table>

        <p>Pas de commentaire \o/ et un nouveau champ par propri√©t√© du VO.</p>
    </div></section>


    <section class="slide"><div>
        <h2>Utilisation ais√©e</h2>

        <pre><code class="language-php">$ristretto = CapsuleType::fromValues('Ristretto');

$user      = new User();
$user->setFavoriteCapsuleType($ristretto);

$entityManager->persist($capsule);
$entityManager->flush();</code></pre>

        <p>Rien de nouveau, on manipule des objets.</p>
    </div></section>



    <section class="slide"><div>
        <h2>En base de donn√©e</h2>

        <table>
            <tr>
                <th scope="row">id</th>
                <td>1</td>
            </tr>
            <tr>
                <th scope="row">favoriteCapsuleType_name</th>
                <td>Ristretto</td>
            </tr>
            <tr class="next">
                <th scope="row">favoriteCapsuleType_intensity</th>
                <td>12</td>
            </tr>
            <tr class="next">
                <th scope="row">favoriteCapsuleType_color</th>
                <td>pink</td>
            </tr>
        </table>

        <p>Beaucoup plus propre !</p>
    </div></section>




    <section class="slide"><div>
        <h2>Hydratation en VO aussi !</h2>

        <pre><code class="language-php">$entityManager->find(User::class, 1);

class Model\User {
    private $id => int(1)
    private $favoriteCapsuleType => class Model\CapsuleType {
        private $name => string(9) "Ristretto"
        // ...
    }
}</code></pre>

        <p>Identique au type <code>object</code>.</p>
    </div></section>


    <section class="slide"><div>
        <h2>DQL Intelligent</h2>

        <pre><code class="language-php">$queryBuilder->from(User::class, 'u')->select('u');
$queryBuilder->where('u.favoriteCapsuleType.name = :name');
$queryBuilder->setParameter('name', 'Ristretto');</code></pre>

        <p>On n'utilise pas <code>favoriteCapsuleType_name</code>,<br >
            mais bien <code>User->favoriteCapsuleType->name</code> !</p>

        <p>Et on peut faire des recherches sur les champs du VO.</p>
    </div></section>


    <section class="slide"><div>
        <h2>Dans les deux cas, attention √† l'hydratation</h2>

        <ul>
            <li>N'instancie pas les objets comme vous :
                <ul>
                    <li><code>__construct()</code></li>
                    <li><code>fromValues()</code></li>
                </ul>
            </li>
            <li>Peux provoquer des √©tats invalide si la BDD est manipul√©e ailleurs ;</li>
            <li>Ne r√©utilise pas la m√™me instance d'un VO a chaque fois qu'il le rencontre.</li>
        </ul>
    </div></section>



    <section class="slide cover"><div style="padding: 105px 120px 0;">
        <h2 style="background: none;margin-top: 100px;">Le VO Nullable</h2>
        <img src="pictures/pasBon.png" alt="" style="width: 100%;">
    </div></section>



    <section class="slide"><div>
        <h2>Lo√Øck n'aime pas le caf√©</h2>

        <pre><code class="language-php">$loick = new User();
$loick>setFavoriteCapsuleType(null); // Aucun type de capsule pr√©f√©r√©</code></pre>

        <p><blockquote>SQLSTATE[23000]: Integrity constraint violation: 1048 Column 'favoriteCapsuleType' cannot be null</blockquote></p>
    </div></section>



    <section class="slide"><div>
        <h2>Nullable √† la rescousse</h2>

        <pre><code class="language-php">/** @Entity */
class User
{
    /**
     * @var CapsuleType
     * @Column(type="object", nullable=true)
     */
    private $favoriteCapsuleType;
}</code></pre>
    </div></section>



    <section class="slide"><div>
        <h2>Moyen support√© avec le type <code>object</code></h2>


        <table>
            <tr>
                <th scope="col">id</th>
                <th>name</th>
                <th>favoriteCapsuleType</th>
            </tr>
            <tr>
                <td>1</td>
                <td>Damien</td>
                <td>O:17:"Model\CapsuleType"...</td>
            </tr>
            <tr>
                <td>2</td>
                <td>Loick</td>
                <td>N;</td>
            </tr>
        </table>


        <ul>
            <li>M√™me vide, le champ est s√©rialis√©, et <code>serialize(NULL)</code> === <code>N;</code> ;</li>
            <li>Dans vos Query, vous ne pouvez pas utiliser <code>WHERE x IS NULL</code> ;</li>
            <li><code>nullable=true</code> ne sert √† rien sur un type <code>object</code>.</li>
        </ul>
    </div></section>


    <section class="slide"><div>
        <h2>Non support√© avec <code>Embedded</code></h2>

        <ul>
            <li>Pas d'option <code>nullable</code> sur <code>@Embedded</code> ;</li>
            <li>Donc on met <code>nullable</code> sur tous les champs du <code>@Embeddable</code> üòû

                <ul>
                    <li>Augmente le risque de VO invalide ;</li>
                    <li>Comment savoir si le VO est vide, ou si il n'existe pas ?</li>
                    <li>Comment faire un WHERE sur la nullit√© ? Il faut tester tous les champs ?</li>
                </ul>
            </li>
        </ul>
    </div></section>


    <section class="slide"><div>
        <h2>Rendre tous les champs du VO nullable</h2>

        <pre><code class="language-php">// R√©sultat d'une Query

class Model\User {
    private $id => int(1)
    private $name => string(5) "Loick"
    private $favoriteCapsuleType => class Model\CapsuleType {
        private $name => NULL
    }
}</code></pre>

        <p>On r√©cup√®re une instance invalide de CapsuleType depuis l'ORM.</p>
    </div></section>



    <section class="slide"><div>
        <h2>Code userland √† la rescousse !</h2>

        <pre><code class="language-php">/** @Entity */
class User
{
    /**
     * @Column(type="boolean")
     */
    private $hasFavoriteCapsuleType = false;

    /**
     * @Embedded(class="CapsuleType")
     */
    private $favoriteCapsuleType;</code></pre>

        <p>On ajoute un boolean <code>hasFavoriteCapsuleType</code>.</p>
    </div></section>



    <section class="slide"><div style="padding: 40px 60px; width: 900px;">
        <h2>Ajout de logique dans les getter / setter</h2>

        <pre><code class="language-php">/**
 * @return CapsuleType|null
 */
public function getFavoriteCapsuleType()
{
    return $this->hasFavoriteCapsuleType() ? $this->favoriteCapsuleType : null;
}

/**
 * @param CapsuleType|null $favoriteCapsuleType
 */
public function setFavoriteCapsuleType(CapsuleType $favoriteCapsuleType = null)
{
    $this->favoriteCapsuleType      = $favoriteCapsuleType;
    $this->hasFavoriteCapsuleType   = $favoriteCapsuleType ? true : false;
}
</code></pre>
    </div></section>


    <section class="slide"><div>
        <h2>Beaucoup de code mais plein d'avantages !</h2>

        <pre><code class="language-php">$qb = $entityManager->createQueryBuilder();
$qb->from(User::class, 'u')->select('u')
   ->where('u.hasFavoriteCapsuleType = :has');
$qb->setParameter('has', true);</code></pre>

        <ul>
            <li>Requ√™te simplifi√©e (on ne test que le boolean) ;</li>
            <li>Le getter nous retourne ce que nous voulons ;</li>
            <li>Interop√©rable ;</li>
            <li>Le meilleur des deux mondes !</li>
        </ul>
    </div></section>



    <section class="slide"><div>
        <h2>Quelques inconv√©nients</h2>

        <ul>
            <li>Doctrine va toujours hydrater le VO, m√™me si "null" ;</li>
            <li>Il faut quand m√™me rendre tous les champs <code>nullable</code>.</li>
        </ul>
    </div></section>


    <section class="slide"><div>
        <h2>Mon r√™ve</h2>

        <p>Que l'ORM g√®re √ßa pour nous !</p>

        <pre><code class="language-php">@Embedded(class="CapsuleType", nullable=true)</code></pre>

        <p>Votez avec vos pouces : <a href="https://github.com/doctrine/doctrine2/pull/1275">https://github.com/doctrine/doctrine2/pull/1275</a>.</p>
    </div></section>


    <section class="slide cover"><div>
        <h2 style="left: -40px;">Conclusion</h2>
        <img src="pictures/final.jpg" alt="">
    </div></section>



    <section class="slide"><div>
        <h2>Quand utiliser un VO ?</h2>

        <p style="margin-bottom: 10px;">Posez vous les bonnes questions. Votre objet :</p>

        <ul>
            <li>Mesure, quantifie, d√©crit ?</li>
            <li>Peut rester immutable ?</li>
            <li>Repr√©sente une brique atomique de votre domaine ?</li>
            <li>Est rempla√ßable int√©gralement ?</li>
            <li>Se compare aux autres par sa valeur ?</li>
            <li>Est sans effets de bord ?</li>
            <li class="next"><strong>Vous tenez un bon candidat !</strong></li>
        </ul>
    </div></section>




    <section class="slide"><div>
        <h2>Comment persister un VO ?</h2>

        <ul>
            <li>Avec le type <code>object</code> :
                <ul>
                    <li>Doctrine < 2.5 ;</li>
                    <li>Pas besoin de requ√™ter ;</li>
                    <li>Pas de rigueur ;</li>
                </ul>
            </li>
            <li>Avec <code>Embedded</code> ‚ô• ‚ô• ‚ô• :
                <ul>
                    <li>Dans tous les autres cas !</li>
                    <li>Avec un peu de code userland si vous voulez du vrai nullable.</li>
                </ul>
            </li>
        </ul>
    </div></section>


    <section class="slide"><div>
        <h2>D√©tendez-vous</h2>

        <ul>
            <li>PHP ne propose pas d'objets d'immutables ;</li>
            <li>Votre ORM va faire des doublons ;</li>
            <li>...</li>
        </ul>

        <ul>
            <li class="next">Ce n'est pas grave.</li>
            <li class="next">Votre domaine va gagner en consistence et maintenabilit√©.</li>
            <li class="next">Ne soyez pas trop dur avec vous m√™me.</li>
        </ul>
    </div></section>

    <section class="slide shout"><div>
        <h2>
            The End

            <span>√Ä vos questions ! <small style="font-size: 0.2em; display: block;">(Validation ? Form ? VO dans un VO ?)</small></span>

            <p style="font-size: 25px; line-height: 40px;">
                <a href="https://twitter.com/damienalexandre">@damienalexandre</a><br/>
            </p>
        </h2>
    </div></section>


    <section class="slide"><div>
        <h2>Cr√©dits &amp; bisous</h2>

        <ul>
            <li>Merci Mathieu Darse pour son aide ;</li>
            <li>Merci George Clooney pour son image ;</li>
            <li>Typo ? Sources ? D√©mo PHP ? Tout est <a href="https://github.com/jolicode/value-object-conf">sur Github</a>.</li>
        </ul>

        <p style="text-align: center;"><img src="pictures/logo.svg" style="height:3em; vertical-align: text-bottom;"></p>

        <p>
            <small>The trademarks, trade names or other distinctive brand features of Nespresso ("Trademarks")
                displayed on the slideshow are the exclusive property of Nespresso and/or Nestl√©.</small>
        </p>
    </div></section>

    <div class="progress"><div></div></div>
	<script src="shower/shower.min.js"></script>
	<script src="styles/prism.js"></script>
	<script src="styles/jquery-2.1.1.min.js"></script>
	<script src="styles/progress.js"></script>
</body>
</html>
